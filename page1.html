<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>词条统计 - 私人时间记录器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        success: '#00B42A',
                        danger: '#F53F3F',
                    },
                }
            }
        }
    </script>
    <style>
        .hidden { display: none; }
        #toast { transition: opacity 0.3s, transform 0.3s; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

    <!-- 应用主界面 -->
    <header class="bg-primary text-white py-4 shadow-md">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center">
                <i class="fa fa-bar-chart mr-2"></i>
                备注词条统计
            </h1>
            <a href="./index.html" class="text-white hover:text-gray-200 transition-colors flex items-center text-sm">
                <i class="fa fa-arrow-left mr-1"></i>
                返回主页
            </a>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-6 sm:py-8">
        <div class="max-w-xl mx-auto space-y-6">

            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-lg font-bold text-gray-800 mb-4">词条出现次数排行</h2>
                <div id="stats-container" class="space-y-2">
                    <p class="text-gray-500 text-center py-4">正在检查配置...</p>
                </div>
            </div>

        </div>
    </main>

    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-5 rounded-lg shadow-xl opacity-0 translate-y-10 z-50">
        <p id="toast-message"></p>
    </div>

    <footer class="bg-gray-800 text-white py-4 mt-auto">
        <div class="container mx-auto px-4 text-center text-sm">
            © 私人时间记录器
        </div>
    </footer>

    <script>
        // --- 配置变量 ---
        let config = {
            GITHUB_USERNAME: "",
            GIST_ID: "",
            GITHUB_PAT: ""
        };

        // --- 全局变量 ---
        let records = [];

        // --- 配置管理函数 (与主页完全相同) ---
        function loadConfig() {
            const savedConfig = localStorage.getItem('timeRecorderConfig');
            if (savedConfig) {
                config = JSON.parse(savedConfig);
                return true;
            } else {
                // 如果没有配置，显示提示信息
                const container = document.getElementById('stats-container');
                container.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-red-500 mb-4">未找到配置信息。</p>
                        <a href="./index.html" class="bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary/90">请先前往主页完成配置</a>
                    </div>
                `;
                return false;
            }
        }

        // --- 工具函数 ---
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.classList.remove('bg-success', 'bg-danger', 'bg-gray-800');
            if (type === 'success') toast.classList.add('bg-success');
            else if (type === 'error') toast.classList.add('bg-danger');
            else toast.classList.add('bg-gray-800');
            toast.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-10');
            }, 3000);
        }

        // --- Gist API 核心函数 ---
        async function loadRecordsFromGist() {
            if (!config.GIST_ID) {
                return;
            }
            document.getElementById('stats-container').innerHTML = '<p class="text-gray-500 text-center py-4">正在从云端同步数据...</p>';
            showToast("正在同步数据...", "info");
            try {
                const response = await fetch(`https://gist.githubusercontent.com/${config.GITHUB_USERNAME}/${config.GIST_ID}/raw/records.json?t=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`无法加载Gist: ${response.statusText}`);
                const data = await response.json();
                records = Array.isArray(data) ? data : [];

                // 数据加载成功后，进行统计和渲染
                processAndRenderStats();

                showToast("数据同步成功！", "success");
            } catch (error) {
                console.error("加载记录失败:", error);
                showToast("同步失败，请检查配置或网络。", "error");
                document.getElementById('stats-container').innerHTML = '<p class="text-red-500 text-center py-4">数据同步失败，请刷新重试。</p>';
            }
        }

        // --- 核心统计与渲染函数 ---
        function processAndRenderStats() {
            const container = document.getElementById('stats-container');

            if (records.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">暂无任何记录可供统计。</p>';
                return;
            }

            const remarkCounts = new Map();

            // 1. 遍历所有记录，统计备注词条出现次数
            for (const record of records) {
                const remark = record.remark ? record.remark.trim() : '';
                if (remark) { // 只统计非空备注
                    remarkCounts.set(remark, (remarkCounts.get(remark) || 0) + 1);
                }
            }

            if (remarkCounts.size === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">所有记录均无备注，无法统计。</p>';
                return;
            }

            // 2. 将 Map 转换为数组并按次数降序排序
            const sortedStats = Array.from(remarkCounts.entries())
                .map(([remark, count]) => ({ remark, count }))
                .sort((a, b) => b.count - a.count);

            // 3. 渲染成表格
            container.innerHTML = ''; // 清空容器
            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left text-gray-600';

            table.innerHTML = `
                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                    <tr>
                        <th scope="col" class="px-4 py-2 w-16">排名</th>
                        <th scope="col" class="px-4 py-2">备注词条</th>
                        <th scope="col" class="px-4 py-2 w-24 text-right">次数</th>
                    </tr>
                </thead>
            `;

            const tbody = document.createElement('tbody');
            sortedStats.forEach((stat, index) => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-2 font-medium text-gray-900">${index + 1}</td>
                    <td class="px-4 py-2">${stat.remark}</td>
                    <td class="px-4 py-2 text-right font-semibold text-primary">${stat.count}</td>
                `;
                tbody.appendChild(row);
            });

            table.appendChild(tbody);
            container.appendChild(table);
        }


        // --- 初始化 ---
        document.addEventListener('DOMContentLoaded', () => {
            const hasConfig = loadConfig();

            if (hasConfig) {
                loadRecordsFromGist();
            }
        });
    </script>
</body>
</html>